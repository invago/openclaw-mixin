version: '3.8'

services:
 # Redis服务
 redis:
 image: redis:7-alpine
 container_name: mixin-openclaw-redis
 restart: unless-stopped
 command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}
 ports:
 - "6379:6379"
 volumes:
 - redis_data:/data
 healthcheck:
 test: ["CMD", "redis-cli", "ping"]
 interval:10s
 timeout:5s
 retries:5
 environment:
 - REDIS_PASSWORD=${REDIS_PASSWORD:-}

 #主应用服务
 app:
 build: .
 container_name: mixin-openclaw-app
 restart: unless-stopped
 depends_on:
 redis:
 condition: service_healthy
 ports:
 - "${PORT:-3000}:3000"
 environment:
 - NODE_ENV=production
 - PORT=3000
 - MIXIN_CLIENT_ID=${MIXIN_CLIENT_ID}
 - MIXIN_CLIENT_SECRET=${MIXIN_CLIENT_SECRET}
 - MIXIN_SESSION_ID=${MIXIN_SESSION_ID}
 - MIXIN_PRIVATE_KEY=${MIXIN_PRIVATE_KEY}
 - REDIS_HOST=redis
 - REDIS_PORT=6379
 - REDIS_PASSWORD=${REDIS_PASSWORD:-}
 - WEBHOOK_SECRET=${WEBHOOK_SECRET}
 - JWT_SECRET=${JWT_SECRET}
 - OPENCLAW_API_URL=${OPENCLAW_API_URL:-}
 - OPENCLAW_API_KEY=${OPENCLAW_API_KEY:-}
 volumes:
 - ./logs:/app/logs
 healthcheck:
 test: ["CMD", "curl", "-f", "http://localhost:3000/webhook/health"]
 interval:30s
 timeout:10s
 retries:3
 start_period:40s

 # Nginx反向代理（可选）
 nginx:
 image: nginx:alpine
 container_name: mixin-openclaw-nginx
 restart: unless-stopped
 depends_on:
 - app
 ports:
 - "80:80"
 - "443:443"
 volumes:
 - ./nginx.conf:/etc/nginx/nginx.conf:ro
 - ./ssl:/etc/nginx/ssl:ro

volumes:
 redis_data: